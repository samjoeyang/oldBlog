---
layout: post
status: publish
published: true
title: 根据坐标点绘制网站点击热力图方法
author:
  display_name: Samjoe Yang
  login: blogerlogin
  email: youremail@example.com
  url: http://needis.me
author_login: blogerlogin
author_email: youremail@example.com
author_url: http://needis.me
wordpress_id: 1168
wordpress_url: http://needis.me/?p=1168
date: '2011-01-12 10:33:44 +0800'
date_gmt: '2011-01-12 02:33:44 +0800'
categories:
- Internet
- JAVASCRIPT
tags:
- SEO
- 网站分析
comments: []
---
<p>网站热力图的主要功能是以特殊高亮的形式显示访客热衷的页面区域或访客所在的地理区域。</p>
<p>其特点主要有：</p>
<ol>
<li>可以显示不可点击区域发生的事情。你将发现用户经常会点击那些不是链接的地方，也许你应该在那个地方放置一个资源链接。比如：如果你发现人们总是 在点击某个产品图片，你能想到的是，他们也许想看大图，或者是想了解该产品的更多信息。 同样，他们可能会错误地认为特别的图片就是导航链接。</li>
<li>热力图同时还能告诉你，页面的哪些部分吸引了大多数用户的注意。这对那些对web分析数据没有很多经验的产品人员非常有用。</li>
<li>如果你在一个页面上有多个链接指向同一个URL，例如：如果有不同位置的3个链接指到同一个特定的产品页面 ，那么热力图将会显示你的访客最喜欢点击哪一个链接，这将帮助你提升网页的设计并让它对用户更加友好，不过实现这个功能需要一些设置。</li>
</ol>
<p>下面介绍热力图绘制的方法，注意，以下代码并没有检测数据有效性，也没有对数据进行过滤，剔除脏数据，同时没有处理异常。实际使用时请不要忽略此类情况，否则会对最终结果造成干扰。</p>
<p>假设有一块画布，1200px*2000px尺寸，一组坐标数据，格式为[x,y]二维数组，量级为10000~100000，采样粒度为7*7。依据点坐标的分布密度绘制热力图。</p>
<p><strong>方法一：</strong>使用canvas元素标签将所有点绘制到画布上，每个点给予较低的透明度。然后获取画布每个点的位数据，根据其alpha值(alpha &isin; [0, 255])的大小计算每一位的r，g，b的值，得出所有新的位数据之后，重新绘制。使之呈现为红色&harr;蓝色渐变。</p>
<div>
<div>
<pre style="font-family: monospace;"><span style="color: #006600; font-style: italic;">--假设点坐标为aXY，二维数组*/</span>
<span style="color: #003366; font-weight: bold;">var</span> aXY <span style="color: #339933;">=</span> <span style="color: #009900;">[</span><span style="color: #009900;">[</span>x1<span style="color: #339933;">,</span> y1<span style="color: #009900;">]</span><span style="color: #339933;">,</span> <span style="color: #009900;">[</span>x2<span style="color: #339933;">,</span> y2<span style="color: #009900;">]</span><span style="color: #339933;">,</span> <span style="color: #009900;">[</span>x3<span style="color: #339933;">,</span> y3<span style="color: #009900;">]</span><span style="color: #339933;">,</span> <span style="color: #009900;">[</span>x4<span style="color: #339933;">,</span> y4<span style="color: #009900;">]</span>...<span style="color: #009900;">]</span><span style="color: #339933;">;</span>
<span style="color: #006600; font-style: italic;">//获取canvas的context</span>
<span style="color: #003366; font-weight: bold;">var</span> context <span style="color: #339933;">=</span> canvas.<span style="color: #660066;">getContext</span><span style="color: #009900;">(</span><span style="color: #3366cc;">'2d'</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #003366; font-weight: bold;">var</span> pi2 <span style="color: #339933;">=</span> Math.<span style="color: #660066;">PI</span> <span style="color: #339933;">*</span> <span style="color: #cc0000;">2</span><span style="color: #339933;">;</span>
<span style="color: #006600; font-style: italic;">//设置填充样式，透明度为0.1</span>
context.<span style="color: #660066;">fillStyle</span> <span style="color: #339933;">=</span> <span style="color: #3366cc;">'rgba(255,30,0,0.1)'</span><span style="color: #339933;">;</span>
<span style="color: #000066; font-weight: bold;">for</span> <span style="color: #009900;">(</span><span style="color: #003366; font-weight: bold;">var</span> i <span style="color: #339933;">=</span> <span style="color: #cc0000;">0</span><span style="color: #339933;">,</span> len <span style="color: #339933;">=</span> aXY.<span style="color: #660066;">length</span><span style="color: #339933;">;</span> i <span style="color: #339933;"><</span> len<span style="color: #339933;">;</span> i<span style="color: #339933;">++</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
&nbsp;&nbsp;&nbsp; <span style="color: #003366; font-weight: bold;">var</span> x <span style="color: #339933;">=</span> aXY<span style="color: #009900;">[</span>i<span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #cc0000;">0</span><span style="color: #009900;">]</span><span style="color: #339933;">,</span> y <span style="color: #339933;">=</span> aXY<span style="color: #009900;">[</span>i<span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #cc0000;">1</span><span style="color: #009900;">]</span><span style="color: #339933;">;</span>
&nbsp;&nbsp;&nbsp; context.<span style="color: #660066;">beginPath</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;&nbsp;&nbsp; <span style="color: #006600; font-style: italic;">//绘制圆点</span>
&nbsp;&nbsp;&nbsp; context.<span style="color: #660066;">arc</span><span style="color: #009900;">(</span>x<span style="color: #339933;">,</span> y<span style="color: #339933;">,</span> <span style="color: #cc0000;">6</span><span style="color: #339933;">,</span> <span style="color: #cc0000;">0</span><span style="color: #339933;">,</span> pi2<span style="color: #339933;">,</span> <span style="color: #003366; font-weight: bold;">true</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;&nbsp;&nbsp; context.<span style="color: #660066;">closePath</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;&nbsp;&nbsp; context.<span style="color: #660066;">fill</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span>
<span style="color: #006600; font-style: italic;">//获取这个画布的位数据</span>
<span style="color: #003366; font-weight: bold;">var</span> imgd <span style="color: #339933;">=</span> context.<span style="color: #660066;">getImageData</span><span style="color: #009900;">(</span><span style="color: #cc0000;">0</span><span style="color: #339933;">,</span> <span style="color: #cc0000;">0</span><span style="color: #339933;">,</span> <span style="color: #cc0000;">1200</span><span style="color: #339933;">,</span> <span style="color: #cc0000;">2000</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #003366; font-weight: bold;">var</span> pix <span style="color: #339933;">=</span> imgd.<span style="color: #660066;">data</span><span style="color: #339933;">;</span>
<span style="color: #006600; font-style: italic;">// 循环计算rgb，使之根据alpha值映射到红蓝渐变</span>
<span style="color: #000066; font-weight: bold;">for</span> <span style="color: #009900;">(</span><span style="color: #003366; font-weight: bold;">var</span> i <span style="color: #339933;">=</span> <span style="color: #cc0000;">0</span><span style="color: #339933;">,</span> n <span style="color: #339933;">=</span> pix.<span style="color: #660066;">length</span><span style="color: #339933;">;</span> i <span style="color: #339933;"><</span> n<span style="color: #339933;">;</span> i <span style="color: #339933;">+=</span> <span style="color: #cc0000;">4</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
&nbsp;&nbsp;&nbsp; <span style="color: #006600; font-style: italic;">//位数据的格式为[rgbargbargba&hellip;&hellip;]，每个rgba代表了每个点的rgba四个通道的值</span>
&nbsp;&nbsp;&nbsp; <span style="color: #003366; font-weight: bold;">var</span> a <span style="color: #339933;">=</span> pix<span style="color: #009900;">[</span>i<span style="color: #339933;">+</span><span style="color: #cc0000;">3</span><span style="color: #009900;">]</span><span style="color: #339933;">;</span> <span style="color: #006600; font-style: italic;">//alpha</span>
&nbsp;&nbsp;&nbsp; <span style="color: #006600; font-style: italic;">//red</span>
&nbsp;&nbsp;&nbsp; pix<span style="color: #009900;">[</span>i&nbsp; <span style="color: #009900;">]</span> <span style="color: #339933;">=</span> <span style="color: #cc0000;">128</span> <span style="color: #339933;">*</span> Math.<span style="color: #660066;">sin</span><span style="color: #009900;">(</span><span style="color: #009900;">(</span><span style="color: #cc0000;">1</span> <span style="color: #339933;">/</span> <span style="color: #cc0000;">256</span> <span style="color: #339933;">*</span> a <span style="color: #339933;">-</span> <span style="color: #cc0000;">0.5</span> <span style="color: #009900;">)</span> <span style="color: #339933;">*</span> Math.<span style="color: #660066;">PI</span> <span style="color: #009900;">)</span> <span style="color: #339933;">+</span> <span style="color: #cc0000;">200</span><span style="color: #339933;">;</span>
&nbsp;&nbsp;&nbsp; <span style="color: #006600; font-style: italic;">//green</span>
&nbsp;&nbsp;&nbsp; pix<span style="color: #009900;">[</span>i<span style="color: #339933;">+</span><span style="color: #cc0000;">1</span><span style="color: #009900;">]</span> <span style="color: #339933;">=</span> <span style="color: #cc0000;">128</span> <span style="color: #339933;">*</span> Math.<span style="color: #660066;">sin</span><span style="color: #009900;">(</span><span style="color: #009900;">(</span><span style="color: #cc0000;">1</span> <span style="color: #339933;">/</span> <span style="color: #cc0000;">128</span> <span style="color: #339933;">*</span> a <span style="color: #339933;">-</span> <span style="color: #cc0000;">0.5</span> <span style="color: #009900;">)</span> <span style="color: #339933;">*</span> Math.<span style="color: #660066;">PI</span> <span style="color: #009900;">)</span> <span style="color: #339933;">+</span> <span style="color: #cc0000;">127</span><span style="color: #339933;">;</span>
&nbsp;&nbsp;&nbsp; <span style="color: #006600; font-style: italic;">//blue,128之后直接衰减为0</span>
&nbsp;&nbsp;&nbsp; pix<span style="color: #009900;">[</span>i<span style="color: #339933;">+</span><span style="color: #cc0000;">2</span><span style="color: #009900;">]</span> <span style="color: #339933;">=</span> <span style="color: #cc0000;">256</span> <span style="color: #339933;">*</span> Math.<span style="color: #660066;">sin</span><span style="color: #009900;">(</span><span style="color: #009900;">(</span><span style="color: #cc0000;">1</span> <span style="color: #339933;">/</span> <span style="color: #cc0000;">256</span> <span style="color: #339933;">*</span> a <span style="color: #339933;">+</span> <span style="color: #cc0000;">0.5</span> <span style="color: #009900;">)</span> <span style="color: #339933;">*</span> Math.<span style="color: #660066;">PI</span> <span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;&nbsp;&nbsp; pix<span style="color: #009900;">[</span>i<span style="color: #339933;">+</span><span style="color: #cc0000;">3</span><span style="color: #009900;">]</span> <span style="color: #339933;">=</span> pix<span style="color: #009900;">[</span>i<span style="color: #339933;">+</span><span style="color: #cc0000;">3</span><span style="color: #009900;">]</span> <span style="color: #339933;">*</span> <span style="color: #cc0000;">0.8</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span>
context.<span style="color: #660066;">putImageData</span><span style="color: #009900;">(</span>imgd<span style="color: #339933;">,</span> <span style="color: #cc0000;">0</span><span style="color: #339933;">,</span> <span style="color: #cc0000;">0</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span></pre>
</div>
</div>
<p>上面的代码将会呈现：</p>
<p><img title="heatmap" src="http://www.biaodianfu.com/wp-content/uploads/2011/01/heatmap.png" alt="" width="437" height="289" /></p>
<p>显而易见，这并不是热力图，但是可以精确反映每个点的分布密度，红色表示在该区域的点数据较多，浅，蓝色表示密度小。解决方法是使用径向渐变代替圆点的绘制，用以表示每一个点向周围的点的辐射，渐变色的叠加可以展现梯度变换的效果。代码如下：</p>
<div>
<div>
<pre style="font-family: monospace;"><span style="color: #003366; font-weight: bold;">var</span> aXY <span style="color: #339933;">=</span> <span style="color: #009900;">[</span><span style="color: #009900;">[</span>x1<span style="color: #339933;">,</span> y1<span style="color: #009900;">]</span><span style="color: #339933;">,</span> <span style="color: #009900;">[</span>x2<span style="color: #339933;">,</span> y2<span style="color: #009900;">]</span><span style="color: #339933;">,</span> <span style="color: #009900;">[</span>x3<span style="color: #339933;">,</span> y3<span style="color: #009900;">]</span><span style="color: #339933;">,</span> <span style="color: #009900;">[</span>x4<span style="color: #339933;">,</span> y4<span style="color: #009900;">]</span>...<span style="color: #009900;">]</span><span style="color: #339933;">;</span>
<span style="color: #003366; font-weight: bold;">var</span> context <span style="color: #339933;">=</span> canvas.<span style="color: #660066;">getContext</span><span style="color: #009900;">(</span><span style="color: #3366cc;">'2d'</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #000066; font-weight: bold;">for</span> <span style="color: #009900;">(</span><span style="color: #003366; font-weight: bold;">var</span> i <span style="color: #339933;">=</span> <span style="color: #cc0000;">0</span><span style="color: #339933;">,</span> len <span style="color: #339933;">=</span> aXY.<span style="color: #660066;">length</span><span style="color: #339933;">;</span> i <span style="color: #339933;"><</span> len<span style="color: #339933;">;</span> i<span style="color: #339933;">++</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
&nbsp;&nbsp;&nbsp; <span style="color: #003366; font-weight: bold;">var</span> x <span style="color: #339933;">=</span> aXY<span style="color: #009900;">[</span>i<span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #cc0000;">0</span><span style="color: #009900;">]</span><span style="color: #339933;">,</span> y <span style="color: #339933;">=</span> aXY<span style="color: #009900;">[</span>i<span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #cc0000;">1</span><span style="color: #009900;">]</span><span style="color: #339933;">;</span>
&nbsp;&nbsp;&nbsp; <span style="color: #006600; font-style: italic;">//绘制径向渐变</span>
&nbsp;&nbsp;&nbsp; <span style="color: #003366; font-weight: bold;">var</span> radgrad <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">context</span>.<span style="color: #660066;">createRadialGradient</span><span style="color: #009900;">(</span>x<span style="color: #339933;">,</span> y<span style="color: #339933;">,</span> <span style="color: #cc0000;">1</span><span style="color: #339933;">,</span> x<span style="color: #339933;">,</span> y<span style="color: #339933;">,</span> <span style="color: #cc0000;">8</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;&nbsp;&nbsp; <span style="color: #006600; font-style: italic;">//锚点</span>
&nbsp;&nbsp;&nbsp; radgrad.<span style="color: #660066;">addColorStop</span><span style="color: #009900;">(</span> <span style="color: #cc0000;">0</span><span style="color: #339933;">,</span> <span style="color: #3366cc;">'rgba(255,30,0,1)'</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;&nbsp;&nbsp; <span style="color: #006600; font-style: italic;">//锚点</span>
&nbsp;&nbsp;&nbsp; radgrad.<span style="color: #660066;">addColorStop</span><span style="color: #009900;">(</span> <span style="color: #cc0000;">1</span><span style="color: #339933;">,</span> <span style="color: #3366cc;">'rgba(255,30,0,0)'</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;&nbsp;&nbsp; context.<span style="color: #660066;">fillStyle</span> <span style="color: #339933;">=</span> radgrad<span style="color: #339933;">;</span>
&nbsp;&nbsp;&nbsp; context.<span style="color: #660066;">fillRect</span><span style="color: #009900;">(</span> x <span style="color: #339933;">-</span> <span style="color: #cc0000;">8</span><span style="color: #339933;">,</span> y <span style="color: #339933;">-</span> <span style="color: #cc0000;">8</span><span style="color: #339933;">,</span> <span style="color: #cc0000;">16</span><span style="color: #339933;">,</span> <span style="color: #cc0000;">16</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre>
</div>
</div>
<p><img title="heat-map" src="http://www.biaodianfu.com/wp-content/uploads/2011/01/heat-map.png" alt="" width="401" height="280" /></p>
<p>方案度量：这是比较简单的实现方案，稍微麻烦的地方在于根据alpha值计算红蓝绿值，使得alpha高的地方显示红色，alpha低的显示蓝色， 中间部分显示黄/绿色(考虑到效率与简单性，使用了简单的三角函数，如果需要更为精确的色相渐变，可以使用幂次变换)。同时这个方案的缺点也十分明显：在 点数据量低的时候效率很高，但是点数据超过10000之后就会有明显的时间延迟>3s，原因在于循环绘制渐变色会消耗资源。其次该方案的性能也会取 决于画布的大小。画布大的情况，比如画布尺寸为1200*3000，对其取位数据的时候，将会循环360万次，同时进行3*360万sin运算~~对于客 户端性能是个问题。</p>
<p><strong>方法二：</strong>对所有点数据进行计算，得出每个点的密度值，然后依据密度值由低到高，绘制点数据。</p>
<div>
<div>
<pre style="font-family: monospace;"><span style="color: #003366; font-weight: bold;">var</span> points <span style="color: #339933;">=</span> <span style="color: #009900;">[</span><span style="color: #009900;">[</span>x1<span style="color: #339933;">,</span> y1<span style="color: #009900;">]</span><span style="color: #339933;">,</span> <span style="color: #009900;">[</span>x2<span style="color: #339933;">,</span> y2<span style="color: #009900;">]</span><span style="color: #339933;">,</span> <span style="color: #009900;">[</span>x3<span style="color: #339933;">,</span> y3<span style="color: #009900;">]</span><span style="color: #339933;">,</span> <span style="color: #009900;">[</span>x4<span style="color: #339933;">,</span> y4<span style="color: #009900;">]</span>...<span style="color: #009900;">]</span><span style="color: #339933;">;</span>
<span style="color: #003366; font-weight: bold;">var</span> cache <span style="color: #339933;">=</span> <span style="color: #009900;">{</span><span style="color: #009900;">}</span><span style="color: #339933;">;</span>
<span style="color: #006600; font-style: italic;">//计算每个点的密度</span>
<span style="color: #000066; font-weight: bold;">for</span> <span style="color: #009900;">(</span><span style="color: #003366; font-weight: bold;">var</span> i <span style="color: #339933;">=</span> <span style="color: #cc0000;">0</span><span style="color: #339933;">,</span> len <span style="color: #339933;">=</span> points.<span style="color: #660066;">length</span><span style="color: #339933;">;</span> i <span style="color: #339933;"><</span> len<span style="color: #339933;">;</span> i<span style="color: #339933;">++</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
&nbsp;&nbsp;&nbsp; <span style="color: #000066; font-weight: bold;">for</span> <span style="color: #009900;">(</span><span style="color: #003366; font-weight: bold;">var</span> j <span style="color: #339933;">=</span> <span style="color: #cc0000;">0</span><span style="color: #339933;">,</span> len2 <span style="color: #339933;">=</span> points<span style="color: #009900;">[</span>i<span style="color: #009900;">]</span>.<span style="color: #660066;">length</span><span style="color: #339933;">;</span> j <span style="color: #339933;"><</span> len2<span style="color: #339933;">;</span> j<span style="color: #339933;">++</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #003366; font-weight: bold;">var</span> key <span style="color: #339933;">=</span> points<span style="color: #009900;">[</span>i<span style="color: #009900;">]</span><span style="color: #009900;">[</span>j<span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #cc0000;">0</span><span style="color: #009900;">]</span> <span style="color: #339933;">+</span> <span style="color: #3366cc;">'*'</span> <span style="color: #339933;">+</span> points<span style="color: #009900;">[</span>i<span style="color: #009900;">]</span><span style="color: #009900;">[</span>j<span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #cc0000;">1</span><span style="color: #009900;">]</span><span style="color: #339933;">;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">(</span>cache<span style="color: #009900;">[</span>key<span style="color: #009900;">]</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cache<span style="color: #009900;">[</span>key<span style="color: #009900;">]</span> <span style="color: #339933;">++;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #009900;">}</span> <span style="color: #000066; font-weight: bold;">else</span> <span style="color: #009900;">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cache<span style="color: #009900;">[</span>key<span style="color: #009900;">]</span> <span style="color: #339933;">=</span> <span style="color: #cc0000;">1</span><span style="color: #339933;">;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #009900;">}</span>
&nbsp;&nbsp;&nbsp; <span style="color: #009900;">}</span>
<span style="color: #009900;">}</span>
<span style="color: #006600; font-style: italic;">//点数据还原</span>
<span style="color: #003366; font-weight: bold;">var</span> oData <span style="color: #339933;">=</span> <span style="color: #009900;">[</span><span style="color: #009900;">]</span><span style="color: #339933;">;</span>
<span style="color: #000066; font-weight: bold;">for</span> <span style="color: #009900;">(</span><span style="color: #003366; font-weight: bold;">var</span> m <span style="color: #000066; font-weight: bold;">in</span> cache<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
&nbsp;&nbsp;&nbsp; <span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">(</span>m <span style="color: #339933;">==</span> <span style="color: #3366cc;">'0*0'</span><span style="color: #009900;">)</span> <span style="color: #000066; font-weight: bold;">continue</span><span style="color: #339933;">;</span>
&nbsp;&nbsp;&nbsp; <span style="color: #003366; font-weight: bold;">var</span> x <span style="color: #339933;">=</span> parseInt<span style="color: #009900;">(</span>m.<span style="color: #660066;">split</span><span style="color: #009900;">(</span><span style="color: #3366cc;">'*'</span><span style="color: #009900;">)</span><span style="color: #009900;">[</span><span style="color: #cc0000;">0</span><span style="color: #009900;">]</span><span style="color: #339933;">,</span> <span style="color: #cc0000;">10</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;&nbsp;&nbsp; <span style="color: #003366; font-weight: bold;">var</span> y <span style="color: #339933;">=</span> parseInt<span style="color: #009900;">(</span>m.<span style="color: #660066;">split</span><span style="color: #009900;">(</span><span style="color: #3366cc;">'*'</span><span style="color: #009900;">)</span><span style="color: #009900;">[</span><span style="color: #cc0000;">1</span><span style="color: #009900;">]</span><span style="color: #339933;">,</span> <span style="color: #cc0000;">0</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;&nbsp;&nbsp; oData.<span style="color: #660066;">push</span><span style="color: #009900;">(</span><span style="color: #009900;">[</span>x<span style="color: #339933;">,</span> y<span style="color: #339933;">,</span> cache<span style="color: #009900;">[</span>m<span style="color: #009900;">]</span><span style="color: #009900;">]</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span>
<span style="color: #006600; font-style: italic;">//简单排序，使用数组内建的sort</span>
oData.<span style="color: #660066;">sort</span><span style="color: #009900;">(</span><span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">(</span>a<span style="color: #339933;">,</span> b<span style="color: #009900;">)</span><span style="color: #009900;">{</span>
&nbsp;&nbsp;&nbsp; <span style="color: #000066; font-weight: bold;">return</span> a<span style="color: #009900;">[</span><span style="color: #cc0000;">2</span><span style="color: #009900;">]</span> <span style="color: #339933;">-</span> b<span style="color: #009900;">[</span><span style="color: #cc0000;">2</span><span style="color: #009900;">]</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #003366; font-weight: bold;">var</span> max <span style="color: #339933;">=</span> oData<span style="color: #009900;">[</span>oData.<span style="color: #660066;">length</span> <span style="color: #339933;">-</span> <span style="color: #cc0000;">1</span><span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #cc0000;">2</span><span style="color: #009900;">]</span><span style="color: #339933;">;</span>
<span style="color: #003366; font-weight: bold;">var</span> pi2 <span style="color: #339933;">=</span> Math.<span style="color: #660066;">PI</span> <span style="color: #339933;">*</span> <span style="color: #cc0000;">2</span><span style="color: #339933;">;</span>
<span style="color: #006600; font-style: italic;">//设置阈值，可以过滤掉密度极小的点</span>
<span style="color: #003366; font-weight: bold;">var</span> threshold <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">this</span>._points_min_threshold <span style="color: #339933;">*</span> max<span style="color: #339933;">;</span>
<span style="color: #006600; font-style: italic;">//alpha增强参数</span>
<span style="color: #003366; font-weight: bold;">var</span> pr <span style="color: #339933;">=</span> <span style="color: #009900;">(</span>Math.<span style="color: #660066;">log</span><span style="color: #009900;">(</span><span style="color: #cc0000;">245</span><span style="color: #009900;">)</span><span style="color: #339933;">-</span><span style="color: #cc0000;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">/</span><span style="color: #cc0000;">245</span><span style="color: #339933;">;</span>
<span style="color: #000066; font-weight: bold;">for</span> <span style="color: #009900;">(</span><span style="color: #003366; font-weight: bold;">var</span> i <span style="color: #339933;">=</span> <span style="color: #cc0000;">0</span><span style="color: #339933;">,</span> len <span style="color: #339933;">=</span> oData.<span style="color: #660066;">length</span><span style="color: #339933;">;</span> i <span style="color: #339933;"><</span> len<span style="color: #339933;">;</span> i<span style="color: #339933;">++</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
&nbsp;&nbsp;&nbsp; <span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">(</span>oData<span style="color: #009900;">[</span>i<span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #cc0000;">2</span><span style="color: #009900;">]</span>&nbsp; <span style="color: #cc0000;">0</span> <span style="color: #339933;">?</span> <span style="color: #cc0000;">0</span> <span style="color: #339933;">:</span> <span style="color: #cc0000;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;&nbsp;&nbsp; <span style="color: #006600; font-style: italic;">//q参数用于平衡梯度差，使之符合人的感知曲线log2N，如需要精确梯度，去掉log计算</span>
&nbsp;&nbsp;&nbsp; <span style="color: #003366; font-weight: bold;">var</span> q <span style="color: #339933;">=</span> parseInt<span style="color: #009900;">(</span>Math.<span style="color: #660066;">log</span><span style="color: #009900;">(</span>oData<span style="color: #009900;">[</span>i<span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #cc0000;">2</span><span style="color: #009900;">]</span><span style="color: #009900;">)</span> <span style="color: #339933;">/</span> Math.<span style="color: #660066;">log</span><span style="color: #009900;">(</span>max<span style="color: #009900;">)</span> <span style="color: #339933;">*</span> <span style="color: #cc0000;">255</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;&nbsp;&nbsp; <span style="color: #003366; font-weight: bold;">var</span> r <span style="color: #339933;">=</span> parseInt<span style="color: #009900;">(</span><span style="color: #cc0000;">128</span> <span style="color: #339933;">*</span> Math.<span style="color: #660066;">sin</span><span style="color: #009900;">(</span><span style="color: #009900;">(</span><span style="color: #cc0000;">1</span> <span style="color: #339933;">/</span> <span style="color: #cc0000;">256</span> <span style="color: #339933;">*</span> q <span style="color: #339933;">-</span> <span style="color: #cc0000;">0.5</span> <span style="color: #009900;">)</span> <span style="color: #339933;">*</span> Math.<span style="color: #660066;">PI</span> <span style="color: #009900;">)</span> <span style="color: #339933;">+</span> <span style="color: #cc0000;">200</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;&nbsp;&nbsp; <span style="color: #003366; font-weight: bold;">var</span> g <span style="color: #339933;">=</span> parseInt<span style="color: #009900;">(</span><span style="color: #cc0000;">128</span> <span style="color: #339933;">*</span> Math.<span style="color: #660066;">sin</span><span style="color: #009900;">(</span><span style="color: #009900;">(</span><span style="color: #cc0000;">1</span> <span style="color: #339933;">/</span> <span style="color: #cc0000;">128</span> <span style="color: #339933;">*</span> q <span style="color: #339933;">-</span> <span style="color: #cc0000;">0.5</span> <span style="color: #009900;">)</span> <span style="color: #339933;">*</span> Math.<span style="color: #660066;">PI</span> <span style="color: #009900;">)</span> <span style="color: #339933;">+</span> <span style="color: #cc0000;">127</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;&nbsp;&nbsp; <span style="color: #003366; font-weight: bold;">var</span> b <span style="color: #339933;">=</span> parseInt<span style="color: #009900;">(</span><span style="color: #cc0000;">256</span> <span style="color: #339933;">*</span> Math.<span style="color: #660066;">sin</span><span style="color: #009900;">(</span><span style="color: #009900;">(</span><span style="color: #cc0000;">1</span> <span style="color: #339933;">/</span> <span style="color: #cc0000;">256</span> <span style="color: #339933;">*</span> q <span style="color: #339933;">+</span> <span style="color: #cc0000;">0.5</span> <span style="color: #009900;">)</span> <span style="color: #339933;">*</span> Math.<span style="color: #660066;">PI</span> <span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;&nbsp;&nbsp; <span style="color: #003366; font-weight: bold;">var</span> alp <span style="color: #339933;">=</span> <span style="color: #009900;">(</span><span style="color: #cc0000;">0.92</span> <span style="color: #339933;">*</span> q <span style="color: #339933;">+</span> <span style="color: #cc0000;">20</span><span style="color: #009900;">)</span> <span style="color: #339933;">/</span> <span style="color: #cc0000;">255</span><span style="color: #339933;">;</span>
&nbsp;&nbsp;&nbsp; <span style="color: #006600; font-style: italic;">//如果需要灰度增强，则取消此行注释</span>
&nbsp;&nbsp;&nbsp; <span style="color: #006600; font-style: italic;">//var alp = (Math.exp(pr * q + 1) + 10) / 255</span>
&nbsp;&nbsp;&nbsp; <span style="color: #003366; font-weight: bold;">var</span> radgrad <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">context</span>.<span style="color: #660066;">createRadialGradient</span><span style="color: #009900;">(</span>oData<span style="color: #009900;">[</span>i<span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #cc0000;">0</span><span style="color: #009900;">]</span><span style="color: #339933;">,</span> oData<span style="color: #009900;">[</span>i<span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #cc0000;">1</span><span style="color: #009900;">]</span><span style="color: #339933;">,</span> <span style="color: #cc0000;">1</span><span style="color: #339933;">,</span> oData<span style="color: #009900;">[</span>i<span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #cc0000;">0</span><span style="color: #009900;">]</span><span style="color: #339933;">,</span> oData<span style="color: #009900;">[</span>i<span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #cc0000;">1</span><span style="color: #009900;">]</span><span style="color: #339933;">,</span> <span style="color: #cc0000;">8</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;&nbsp;&nbsp; radgrad.<span style="color: #660066;">addColorStop</span><span style="color: #009900;">(</span> <span style="color: #cc0000;">0</span><span style="color: #339933;">,</span> <span style="color: #3366cc;">'rgba('</span> <span style="color: #339933;">+</span> r <span style="color: #339933;">+</span> <span style="color: #3366cc;">','</span> <span style="color: #339933;">+</span> g <span style="color: #339933;">+</span> <span style="color: #3366cc;">','</span><span style="color: #339933;">+</span> b <span style="color: #339933;">+</span> <span style="color: #3366cc;">','</span> <span style="color: #339933;">+</span> alp <span style="color: #339933;">+</span> <span style="color: #3366cc;">')'</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;&nbsp;&nbsp; radgrad.<span style="color: #660066;">addColorStop</span><span style="color: #009900;">(</span> <span style="color: #cc0000;">1</span><span style="color: #339933;">,</span> <span style="color: #3366cc;">'rgba('</span> <span style="color: #339933;">+</span> r <span style="color: #339933;">+</span> <span style="color: #3366cc;">','</span> <span style="color: #339933;">+</span> g <span style="color: #339933;">+</span> <span style="color: #3366cc;">','</span><span style="color: #339933;">+</span> b <span style="color: #339933;">+</span> <span style="color: #3366cc;">',0)'</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;&nbsp;&nbsp; <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">context</span>.<span style="color: #660066;">fillStyle</span> <span style="color: #339933;">=</span> radgrad<span style="color: #339933;">;</span>
&nbsp;&nbsp;&nbsp; <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">context</span>.<span style="color: #660066;">fillRect</span><span style="color: #009900;">(</span> oData<span style="color: #009900;">[</span>i<span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #cc0000;">0</span><span style="color: #009900;">]</span> <span style="color: #339933;">-</span> <span style="color: #cc0000;">8</span><span style="color: #339933;">,</span> oData<span style="color: #009900;">[</span>i<span style="color: #009900;">]</span><span style="color: #009900;">[</span><span style="color: #cc0000;">1</span><span style="color: #009900;">]</span> <span style="color: #339933;">-</span> <span style="color: #cc0000;">8</span><span style="color: #339933;">,</span> <span style="color: #cc0000;">16</span><span style="color: #339933;">,</span> <span style="color: #cc0000;">16</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre>
</div>
</div>
<p>以上代码结果如下：</p>
<p><img title="heatmaps" src="http://www.biaodianfu.com/wp-content/uploads/2011/01/heatmaps.png" alt="" width="597" height="397" /></p>
<p>大约处理了25000个点，用时大约700ms(鄙人的小本性能还行)。属于可接受范围内。</p>
<p>方案度量：此方案性能比方案一有明显优势。目前Marmot采用此方案。</p>
<p>本文来自百度泛用户体验：<a href="http://www.baiduux.com/blog/2010/08/31/%e5%9f%ba%e4%ba%8ecanvas%e7%9a%84%e7%83%ad%e5%8a%9b%e5%9b%be%e7%bb%98%e5%88%b6%e6%96%b9%e6%b3%95/" target="_blank">http://www.baiduux.com/blog/2010/08/31/%e5%9f%ba%e4%ba%8ecanvas%e7%9a%84%e7%83%ad%e5%8a%9b%e5%9b%be%e7%bb%98%e5%88%b6%e6%96%b9%e6%b3%95/</a></p>
<p>其他参考：<a href="http://www.biaodianfu.com/how-to-make-heatmap.html" target="_blank">网站点击热力图的技术实现</a></p>
<p>转自：<a href="http://www.biaodianfu.com/canvas-heatmap.html">标点符</a>.</p>
